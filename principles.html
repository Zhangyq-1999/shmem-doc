

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SHMEM原理概述 &mdash; SHMEM Guidebook 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=d6bf9227" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=8d563738"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="代码组织结构" href="code_organization.html" />
    <link rel="prev" title="初始化" href="example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            SHMEM Guidebook
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">快速开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="related_scripts.html">相关脚本</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using SHMEM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api_demo.html">SHMEM API 样例</a></li>
<li class="toctree-l1"><a class="reference internal" href="compilation_build_guide.html">编译与构建</a></li>
<li class="toctree-l1"><a class="reference internal" href="log_debug.html">SHMEM日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools_debug.html">SHMEM搭配工具算子调测指导</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="def.html">SHMEM DEF</a></li>
<li class="toctree-l1"><a class="reference internal" href="host_api.html">HOST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="device_api.html">DEVICE API</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythonAPI.html">SHMEM Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="env_vars_intro.html">SHMEM Env Vars</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="example.html">初始化</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#allgather">AllGather</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">SHMEM原理概述</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">SHMEM初始化流程介绍</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">多进程间的建链</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">内存堆的初始化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hostdevicestate">host和device间state信息同步</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">共享内存管理初始化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#team">team管理初始化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">同步管理初始化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#shmem-team">SHMEM通信域（Team）介绍</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">子Team切分</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">Team的使用</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="code_organization.html">代码组织结构</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Troubleshooting And FAQs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Troubleshooting_FAQs.html">SHMEM 使用限制</a></li>
<li class="toctree-l1"><a class="reference internal" href="Troubleshooting_FAQs.html#id1">SHMEM 常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security harding and public IP address</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="SECURITY.html">安全声明</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SHMEM Guidebook</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">SHMEM原理概述</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/principles.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="shmem">
<h1>SHMEM原理概述<a class="headerlink" href="#shmem" title="Link to this heading"></a></h1>
<section id="id1">
<h2>SHMEM初始化流程介绍<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p style="text-indent: 2em;">shmem的初始化接口<code>int aclshmemx_init_attr(aclshmemx_init_attr_t *attributes)</code>会根据传入的参数完成shmem功能所需资源的初始化。其中包含多进程间信息的同步以及建链、虚拟内存及device上物理内存的分配和映射、host和device间state信息同步以及初始化共享内存管理、team管理、同步管理功能所需要的资源。这些资源信息都会记录在一个 <code>aclshmem_device_host_state_t</code> 的state里。</p>
<p>初始化流程如下图所示，参数设置及参数校验相关内容不做具体介绍。</p>
<p><img alt="image" src="_images/11.png" /></p>
<section id="id2">
<h3>多进程间的建链<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">以uid初始化流程为例。一般会在初始化接口调用前通过torch的能力将rank0的uid信息广播到所有进程，内部包含rank0节点的ip、port、magic（通信域标识符）等信息。</p>
<p style="text-indent: 2em;">多进程间的建链是基于TCP socket实现的。所有进程会先基于uid内部的ip::port信息和rank0建立连接，连接时会根据uid内magic信息是否一致判断是否为同一通信域，不同则断开连接。连接成功后所有rank与rank0通信，基于此实现host侧的allgather和barrier等能力。（<strong>该部分能力并非aclshmem_barrier相关能力，而是类似于MPI_Barrier</strong>）</p>
<p><img alt="image" src="_images/21.png" /></p>
</section>
<section id="id3">
<h3>内存堆的初始化<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">当前基于驱动能力实现分配虚拟内存、再分配物理内存然后实现虚拟内存和物理内存间的映射，可以在连续的虚拟地址空间管理访问共享内存地址。实际效果和流程可以参考acl接口： <a
href=https://www.hiascend.com/document/detail/zh/canncommercial/82RC1/API/appdevgapi/aclcppdevg_03_0114.html>ACL虚拟内存管理接口</a></p>
<p><img alt="image" src="_images/31.png" /></p>
<p>该部分会分配出两块内存：</p>
<ul class="simple">
<li><p>用户申请的共享内存空间，每个rank申请的内存大小和初始化传入attributes的local_mem_size大小一致，后续可以通过<code class="docutils literal notranslate"><span class="pre">aclshmem_malloc</span></code>、<code class="docutils literal notranslate"><span class="pre">aclshmem_free</span></code>等共享内存接口管理。</p></li>
<li><p>用于在device保存shmem的state、team等元数据空间，当state和team等信息发生变化，进程将自动同步到元数据空间，元数据空间32M，不对外提供访问接口</p></li>
</ul>
</section>
<section id="hostdevicestate">
<h3>host和device间state信息同步<a class="headerlink" href="#hostdevicestate" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">将host的state信息同步。即当host的state发生变化时将其复制一份覆盖到上个阶段分配的在device侧存储state信息的内存中，后续在device侧操作时可以直接拿到更新后的state信息。</p>
<p><img alt="image" src="_images/41.png" /></p>
</section>
<section id="id4">
<h3>共享内存管理初始化<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">基于heap_base和heap_size初始化一个memory_manager用于后续共享内存管理。heap_base为当前rank的共内存首地址，heap_size为用户申请的当前rank的共享内存大小。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aclshmem_malloc</span></code>内部采用first fit找到第一个满足要求的chunk，从该chunk中分离出对应大小的chunk，剩余空间（如果有）则作为新的空闲chunk。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aclshmem_free</span></code>释放后补充空闲chunk 。若新添加chunk与其他空闲chunk连续，则合并。</p></li>
</ul>
<p><img alt="image" src="_images/51.png" /></p>
<p style="text-indent: 2em;"><strong>aclshmem_malloc和aclshmem_free接口使用时需要在所有进程同步调用，且需要分配或释放相同大小的内存。</strong>SHMEM内部默认aclshmem_malloc分配的内存在虚拟地址空间对称，即<strong>当前rank malloc的地址+heap_size=下一个rank malloc的地址</strong>。如果进程间分配内存不同会导致后续分配的内存首地址不对称，无法通过地址偏移访问到正确的数据。</p>
<p><img alt="image" src="_images/malloc.png" /></p>
</section>
<section id="team">
<h3>team管理初始化<a class="headerlink" href="#team" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">创建一个ACLSHMEM_MAX_TEAMS大小的全局team_pool，内部信息全部初始化为-1。
初始化全局team即<code>ACLSHMEM_TEAM_WORLD</code>，start = 0 ; stride = 1 ; size = npes ; mype = mype 即从第0个rank开始，步长为1，全局的pe数量为npes，当前pe为mype(<strong>team相关具体介绍会在team部分做详细梳理，此处仅简单展示全局team的属性信息</strong>)。</p>
<p style="text-indent: 2em;">在device上分配并初始化后续team级别同步需要的资源sync_pool、sync_counter、core_sync_pool、core_sync_counter。前俩个成员用于team内所有的卡间同步、后两个成员用于卡内核间同步。</p>
<p><strong>team_pool、sync_pool、sync_counter、core_sync_pool、core_sync_counter这些信息都会在state里储存。</strong></p>
<p><img alt="image" src="_images/61.png" /></p>
</section>
<section id="id5">
<h3>同步管理初始化<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">该部分仅获取一个ffts地址，后续可通过<code>shmemx_get_ffts_config</code>获得，在算子内通过<code>shmemx_set_ffts_config</code>设置，用于runtime同步，AscendC层面会影响的<code>SyncAll</code>、<code>CrossCoreSetFlag</code>和<code>CrossCoreWaitFlag</code>接口，shmem层面会影响到barrier相关接口。（</ode>shmemx_set_ffts_config</code>开销较小，建议算子内都调用一次该接口）。</p>
<p><img alt="image" src="_images/7.png" /></p>
</section>
</section>
<section id="shmem-team">
<h2>SHMEM通信域（Team）介绍<a class="headerlink" href="#shmem-team" title="Link to this heading"></a></h2>
<p style="text-indent: 2em;">Team是shmem的通信域概念，在相关接口中可以通过`team_id`访问，初始化后会有一个默认的全局通信域，其<code>team_id</code>是<code> ACLSHMEM_TEAM_WORLD = 0</code>。team的信息存储在在state的team_pools里，team_pools是一个aclshmemx_team_t的数组。aclshmemx_team_t内会存储当前team的id（team相关接口使用的索引）、当前进程在该team内的rank id、该team内的起始rank、rank间步长、rank数量等相关信息。</p>
<p><strong>aclshmemx_team_t内存储的mype和size是team内部的信息，aclshmem_device_host_state_t里存储的mype和npes是全局的信息。</strong>
例如：对4个rank初始化shmem，前两卡和后两卡各为一个team。此时这四个rank的state里的mype分别是0,1,2,3。npes则都是4。但team_pools里的mype则分别是0，1，0，1。size为2。</p>
<section id="id6">
<h3>子Team切分<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>shmem提供了专门的接口进行子Team的切分。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">aclshmem_team_split_strided</span><span class="p">(</span><span class="n">aclshmem_team_t</span><span class="w"> </span><span class="n">parent_team</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pe_start</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pe_stride</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pe_size</span><span class="p">,</span><span class="w"> </span><span class="n">aclshmem_team_t</span><span class="w"> </span><span class="o">*</span><span class="n">new_team</span><span class="p">);</span>
</pre></div>
</div>
<p style="text-indent: 2em;">parent_team为父team，pe_start为起始pe，pe_stride为每次划分的步长，pe_size为划分的新team里pe的个数，new_team是出参是切分得到的新team的team_id。</p>
<p>以初始化好8个rank的场景为例，以如下方式调用切分接口。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">aclshmem_team_t</span><span class="w"> </span><span class="n">new_team</span><span class="p">;</span>
<span class="c1">// 从全局通信域中idx为1的pe开始，以步长为2，切分出3个pe后停止。</span>
<span class="k">auto</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aclshmem_team_split_strided</span><span class="p">(</span><span class="n">ACLSHMEM_TEAM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_team</span><span class="p">);</span>
</pre></div>
</div>
<p>此时new_team中有3个pe在state中的mype信息分别为1,3,5，他们的team_pools里的mype信息则分别为0,1,2。</p>
<p><img alt="image" src="_images/8.png" /></p>
</section>
<section id="id7">
<h3>Team的使用<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p style="text-indent: 2em;">当算子只需要在部分rank运行时就会需要用到team相关接口,如<code>aclshmem_team_my_pe(my_team)</code>可以返回当前rank在my_team的mype信息，<code>aclshmem_my_pe()</code>可以返回当前rank在全局的mype信息。通常我们可以用team级别的mype信息作为算子内部资源数组的索引，使用全局的mype作为全局共享内存地址信息的索引。</p>
<p style="text-indent: 2em;">同步接口也会使用到team_id，如shmem内部提供的team内的同步接口<code>aclshmem_barrier(aclshmem_team_t tid)</code>。</p></section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example.html" class="btn btn-neutral float-left" title="初始化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="code_organization.html" class="btn btn-neutral float-right" title="代码组织结构" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright  2025 Huawei Technologies Co., Ltd..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>